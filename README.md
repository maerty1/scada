# SCADA Collector

Система сбора и синхронизации данных SCADA в центральную базу данных.

## Описание

SCADA Collector - это асинхронное Python-приложение для автоматического сбора, синхронизации и мониторинга данных SCADA из различных источников:

- **MSSQL серверы** - синхронизация данных из удаленных MSSQL баз данных
- **Firebird серверы** - синхронизация данных из Firebird баз данных
- **Excel файлы (TC2)** - обработка Excel файлов из сетевых папок
- **Web интерфейс** - мониторинг данных в реальном времени
- **Telegram уведомления** - автоматические уведомления о проблемах с данными

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd python_collector
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Настройте конфигурацию:
   ```bash
   copy config.json.example config.json
   ```
   Отредактируйте `config.json` и укажите реальные значения для:
   - Параметров подключения к базе данных
   - Telegram бота (chat_id, bot_token)
   - Источников данных (sync_mssql, sync_firebird)
   - Сетевых путей (tc2_processor)
   - Учетных данных для службы Windows (service) - опционально

## Конфигурация

Все настройки находятся в файле `config.json`. Пример конфигурации можно найти в `config.json.example`.

### Важные секции:

- **database** - параметры подключения к целевой базе данных
  - `server` - адрес сервера MSSQL
  - `database` - имя базы данных
  - `username`, `password` - учетные данные

- **telegram** - настройки Telegram бота для уведомлений
  - `chat_id` - ID чата для отправки уведомлений
  - `bot_token` - токен Telegram бота
  - `rate_limit_messages` - лимит сообщений в окне
  - `rate_limit_window` - размер окна в секундах
  - `rate_limit_cooldown` - время cooldown после превышения лимита

- **web** - настройки Web интерфейса
  - `host` - хост для привязки (0.0.0.0 для всех интерфейсов)
  - `port` - порт (по умолчанию 80)

- **sync_interval** - интервал синхронизации в секундах (по умолчанию 5)
- **notification_timeout** - timeout для уведомлений в секундах (по умолчанию 7200 = 2 часа)

- **sync_mssql** - список источников MSSQL для синхронизации
  - Каждый элемент содержит: `source_server`, `source_db`, `source_table`, `source_user`, `source_pass`, `target_table`

- **sync_firebird** - список источников Firebird для синхронизации
  - Каждый элемент содержит: `host`, `port`, `database`, `table`, `user`, `password`, `target_table`, `objid`

- **tc2_processor** - настройки обработчика TC2 Excel файлов
  - `enabled` - включить/выключить обработчик
  - `files_directory` - путь к сетевой папке с файлами
  - `monitor_interval` - интервал мониторинга в секундах
  - `file_check_interval` - интервал проверки файлов в секундах (по умолчанию 3600 = 1 час)
  - `days_to_search` - количество дней для поиска файлов
  - `target_table` - целевая таблица в БД
  - `object_id`, `id_value`, `objid_value` - значения для вставки в БД

- **table_names** - маппинг имен таблиц для отображения в Web интерфейсе

- **service** - учетные данные для запуска службы Windows (опционально, используется скриптом setup_service_user.bat)
  - `run_as_user` - доменный пользователь (формат: user@domain)
  - `run_as_password` - пароль пользователя

## Запуск

### Ручной запуск:
```bash
python collector.py
```

Приложение запустит:
- Асинхронные задачи синхронизации (MSSQL, Firebird, TC2)
- Web сервер Flask (по умолчанию на порту 80)
- Мониторинг и уведомления

Для остановки нажмите `Ctrl+C` (graceful shutdown).

### Установка как Windows служба:
См. [SERVICE_SETUP.md](SERVICE_SETUP.md) для подробных инструкций.

**Быстрый старт:**
1. Запустите `install_service.bat` от имени администратора
2. Запустите `setup_service_user.bat` от имени администратора (для доступа к сетевым папкам)
3. Проверьте статус: `.\nssm.exe status SCADA_Collector`

## Логирование

Приложение ведет подробные логи:

- **sync.log** - основные логи приложения
  - Ротация по дням (TimedRotatingFileHandler)
  - Сжатие старых логов (gzip)
  - Уровни: INFO, WARNING, ERROR, DEBUG

- **service_stdout.log** - стандартный вывод службы Windows
- **service_stderr.log** - ошибки службы Windows

Логи содержат информацию о:
- Синхронизации данных (количество записей, таблицы)
- Ошибках подключения и обработки
- Уведомлениях Telegram
- Обработке TC2 файлов
- Состоянии задач (healthcheck)

## Мониторинг

### Healthcheck API

```bash
curl http://localhost/health
```

Возвращает JSON с состоянием всех задач синхронизации:
- Статус каждой задачи (healthy/unhealthy)
- Время последней синхронизации
- Ошибки (если есть)

### Web интерфейс

Откройте в браузере: `http://localhost/`

Отображает:
- Таблицу с последними данными из всех таблиц
- Время последнего обновления (RECTIME)
- Индикацию устаревших данных
- Автоматическое обновление каждые 5 секунд

## Безопасность

⚠️ **ВАЖНО**: Файл `config.json` содержит чувствительные данные (пароли, токены) и **НЕ должен** попадать в систему контроля версий.

- Файл `config.json` уже добавлен в `.gitignore`
- Используйте `config.json.example` как шаблон для настройки
- Никогда не коммитьте реальный `config.json` в репозиторий
- Храните пароли и токены в безопасном месте
- Используйте доменные учетные записи с минимальными необходимыми правами для службы

## Функциональность

### Синхронизация данных

- **MSSQL → MSSQL**: Асинхронная синхронизация данных из источников MSSQL в целевую базу данных
  - Интервал синхронизации: настраивается в `config.json` (по умолчанию 5 секунд)
  - Автоматическое определение новых записей по `RECTIME`
  - Поддержка множественных источников

- **Firebird → MSSQL**: Синхронизация данных из Firebird баз данных
  - Фильтрация по `OBJID` для разделения данных
  - Асинхронная обработка через ThreadPoolExecutor

- **TC2 Excel → MSSQL**: Обработка Excel файлов из сетевых папок
  - Мониторинг файлов по шаблону `YYYY-MM-DD_TC-2.xlsx`
  - Обработка без блокировки оригинальных файлов (копирование во временный файл)
  - Проверка дубликатов перед вставкой
  - Интервал проверки: настраивается (по умолчанию 1 час)

### Мониторинг и уведомления

- **Проверка актуальности данных**: Автоматическая проверка последнего времени обновления каждой таблицы
- **Telegram уведомления**: Отправка уведомлений при устаревании данных
  - Настраиваемый timeout (по умолчанию 2 часа)
  - Rate limiting для предотвращения спама
  - Защита от дублирования уведомлений

### Web интерфейс

- **Healthcheck**: `/health` - проверка состояния системы и всех задач синхронизации
- **Данные**: `/data` - JSON API с последними данными из всех таблиц
- **Главная страница**: `/` - HTML интерфейс с таблицей данных в реальном времени
  - Автоматическое обновление каждые 5 секунд
  - Фиксированные размеры ячеек для стабильности отображения
  - Индикация устаревших данных

## Генерация схемы архитектуры

Для создания визуальной схемы архитектуры системы используйте скрипт:

```bash
python generate_schema_diagram.py
```

Это создаст файл `SCADA_Collector_Architecture.pdf` с:
- Визуальной диаграммой потока данных (блоки и стрелки)
- Детальной информацией о конфигурации
- Список всех источников данных и целевых таблиц

**Требования**: `reportlab` (устанавливается через `pip install -r requirements.txt`)

## Структура проекта

```
python_collector/
├── collector.py              # Основной файл приложения
├── config.json               # Конфигурация (не в git)
├── config.json.example       # Пример конфигурации
├── generate_schema_diagram.py # Генератор PDF схемы архитектуры
├── read_config.py            # Утилита для чтения конфигурации
├── .gitignore                # Игнорируемые файлы
├── requirements.txt          # Зависимости Python
├── install_service.bat       # Установка Windows службы
├── uninstall_service.bat     # Удаление Windows службы
├── setup_service_user.bat    # Настройка доменного пользователя для службы
├── restart_service_admin.bat # Перезапуск службы (требует админ права)
├── nssm.exe                  # Non-Sucking Service Manager
├── README.md                 # Документация (этот файл)
├── SERVICE_SETUP.md         # Документация по настройке службы
└── sync.log                  # Логи приложения (ротация по дням)
```

## Технические детали

### Технологии

- **Python 3.x** - основной язык
- **asyncio** - асинхронная обработка
- **aioodbc** - асинхронные подключения к MSSQL
- **pyodbc** - синхронные подключения к MSSQL (для Flask)
- **fdb** - подключения к Firebird
- **pandas** - обработка Excel файлов
- **Flask** - Web интерфейс
- **aiohttp** - асинхронные HTTP запросы (Telegram)
- **SQLAlchemy** - пул соединений для Flask

### Архитектура

- **Асинхронная обработка**: Все задачи синхронизации выполняются асинхронно
- **ThreadPoolExecutor**: Синхронные операции (Firebird, файлы) выполняются в отдельных потоках
- **Connection pooling**: Переиспользование соединений к БД
- **Graceful shutdown**: Корректное завершение работы при остановке
- **Rate limiting**: Защита от спама в Telegram уведомлениях
- **Deduplication**: Проверка дубликатов перед вставкой данных

### Производительность

- Поддержка множественных источников данных одновременно
- Параллельная обработка задач синхронизации
- Кэширование последних значений RECTIME для оптимизации запросов
- Оптимизированная обработка Excel файлов (копирование во временный файл)

## Устранение неполадок

### Проблемы с доступом к сетевой папке

1. Убедитесь, что служба запущена от имени доменного пользователя:
   ```cmd
   .\nssm.exe get SCADA_Collector ObjectName
   ```

2. Проверьте права доступа пользователя к сетевой папке

3. Проверьте логи: `sync.log` и `service_stderr.log`

### Проблемы с синхронизацией

1. Проверьте подключение к источникам данных:
   - MSSQL: доступность сервера и учетные данные
   - Firebird: доступность сервера и путь к БД

2. Проверьте логи на наличие ошибок подключения

3. Используйте healthcheck API для проверки состояния задач

### Проблемы с Telegram уведомлениями

1. Проверьте `bot_token` и `chat_id` в `config.json`
2. Убедитесь, что бот добавлен в чат
3. Проверьте rate limiting настройки

## Разработка

### Зависимости

Все зависимости указаны в `requirements.txt`. Для установки:

```bash
pip install -r requirements.txt
```

### Структура кода

- `collector.py` - основной файл с логикой синхронизации
- Асинхронные функции для MSSQL и Firebird синхронизации
- Синхронные функции для обработки файлов (в ThreadPoolExecutor)
- Flask приложение для Web интерфейса
- Логирование с ротацией файлов

## Лицензия

[Укажите лицензию]

