# Настройка службы SCADA Collector

## Конфигурация в config.json

Учетные данные для доступа к сетевой папке хранятся в секции `service`:

```json
{
    "service": {
        "run_as_user": "user@domain",
        "run_as_password": "P@ssw0rd"
    }
}
```

**Важно:** Авторизация в сетевую папку происходит **через приложение** (collector.py), а не через параметры службы. Служба может запускаться от имени SYSTEM, а приложение само подключается к сетевой папке с использованием учетных данных из `config.json`.

## Установка и настройка службы

### 1. Установка службы

Запустите `install_service.bat` от имени администратора:
- Установит службу SCADA_Collector
- Настроит автоматический запуск
- Настроит логирование
- Настроит переменные окружения (PYTHONPATH)

**Служба будет запускаться от имени SYSTEM** - это нормально, так как авторизация происходит через приложение.

### 2. Сброс настройки пользователя службы (если была установлена ранее)

Если ранее была настроена авторизация через параметры службы, запустите `reset_service_user.bat`:
- Сбросит настройку пользователя службы
- Служба будет запускаться от имени SYSTEM
- Авторизация в сетевую папку будет происходить через приложение

## Проверка службы

После настройки проверьте:

1. **Статус службы:**
   ```cmd
   .\nssm.exe status SCADA_Collector
   ```
   Должен быть: `SERVICE_RUNNING`

2. **Процессы Python:**
   ```cmd
   tasklist | findstr python
   ```
   Должен быть виден процесс `python.exe`

3. **Логи:**
   - `service_stdout.log` - стандартный вывод
   - `service_stderr.log` - ошибки
   - `sync.log` - основные логи приложения
   
   В логах должны быть сообщения:
   ```
   TC2: Попытка подключения к сетевой папке с учетными данными: shabalin.ev@vet.uz
   TC2: Успешное подключение к сетевой папке: \\192.168.222.241\c$
   TC2: Сетевая папка доступна
   ```

4. **Доступ к сетевой папке:**
   Приложение автоматически подключается к `\\192.168.222.241\c$\hscmt\cal\H`
   с использованием учетных данных из `config.json` (секция `service`).

## Как работает авторизация

1. Служба запускается от имени **SYSTEM** (или другого пользователя, если настроено)
2. При запуске TC2 процессора приложение читает учетные данные из `config.json` (секция `service`)
3. Приложение выполняет команду `net use` для подключения к сетевой папке с этими учетными данными
4. После успешного подключения приложение получает доступ к файлам в сетевой папке

## Важно

- Все скрипты настройки службы должны запускаться **от имени администратора**
- Убедитесь, что пользователь из `config.json` имеет права доступа к сетевой папке
- После изменения учетных данных в `config.json` **перезапустите службу** - изменения применятся автоматически
- Служба может запускаться от имени SYSTEM - авторизация происходит через приложение

